# Model Comparison: Claude 3 Haiku vs Gemini 2.0 Flash
# Run: cd eval/router_eval && npx promptfoo eval -c promptfooconfig_gemini_vs_haiku.yaml

description: "Router Model Comparison - Haiku vs Gemini Flash"

prompts:
  - file://prompts/router_v2.txt

providers:
  - id: openrouter:anthropic/claude-3-haiku
    label: claude-3-haiku
    config:
      temperature: 0
      max_tokens: 500

  - id: openrouter:google/gemini-2.0-flash-001
    label: gemini-flash
    config:
      temperature: 0
      max_tokens: 500

defaultTest:
  vars:
    manifest: file://manifest.txt

# Helper to parse JSON (handles markdown wrappers)
transform: |
  let text = output;
  if (text.includes('```')) {
    text = text.split('```')[1];
    if (text.startsWith('json')) text = text.slice(4);
  }
  return text.trim();

tests:
  # ===== STATE FILTERS (8 tests) =====
  - vars:
      query: "What did Ohio voters say about jobs?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-007'));

  - vars:
      query: "How do Michigan voters feel about the economy?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-001') || id.includes('race-009'));

  - vars:
      query: "Pennsylvania voters on healthcare"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-002') || id.includes('race-010'));

  - vars:
      query: "What did Wisconsin voters think about education?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-003') || id.includes('race-012'));

  - vars:
      query: "Georgia voters on voting rights"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-004'));

  - vars:
      query: "Arizona immigration concerns"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-005'));

  - vars:
      query: "North Carolina suburban voters"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-011'));

  - vars:
      query: "Montana rural voters"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && ids.every(id => id.includes('race-008'));

  # ===== DEMOGRAPHIC FILTERS (4 tests) =====
  - vars:
      query: "What do working-class voters think about trade?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          // Should filter to working-class FGs OR return all (acceptable)
          return result.all === true || (result.focus_group_ids && result.focus_group_ids.length > 0);

  - vars:
      query: "Latino voters on immigration"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('latino') || id.includes('race-005-fg-002') || id.includes('race-006-fg-003'));

  - vars:
      query: "Black voters in Georgia"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('race-004-fg-002') || id.includes('black') || id.includes('race-004'));

  - vars:
      query: "College-educated suburban voters"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          // Can filter or return all - both acceptable for this query
          return result.all === true || (result.focus_group_ids && result.focus_group_ids.length > 0);

  # ===== BROAD QUERIES - SHOULD RETURN ALL (4 tests) =====
  - vars:
      query: "What do voters think about the economy?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  - vars:
      query: "How do people feel about inflation?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  - vars:
      query: "Voter concerns about healthcare costs"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  - vars:
      query: "What messaging resonates with swing voters?"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  # ===== COMPOUND FILTERS (2 tests) =====
  - vars:
      query: "Working-class Ohio voters on manufacturing"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('race-007'));

  - vars:
      query: "Pennsylvania suburban voters 2024"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('race-010'));

  # ===== EDGE CASES (2 tests) =====
  - vars:
      query: "California voters on housing"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length === 0 || result.reason;

  - vars:
      query: "Cleveland suburbs on local issues"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('cleveland') || id.includes('race-007-fg-001'));
