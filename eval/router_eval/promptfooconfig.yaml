# Router Prompt Evaluation
# Run: cd eval/router_eval && npx promptfoo eval

description: "LLM Router - Focus Group Selection"

prompts:
  - file://prompts/router_v1.txt  # Current prompt (baseline)
  - file://prompts/router_v2.txt  # New prompt (to test)

providers:
  - id: openai:chat:anthropic/claude-3-haiku
    config:
      apiKey: ${OPENROUTER_API_KEY}
      apiBaseUrl: https://openrouter.ai/api/v1
      temperature: 0
      max_tokens: 500

defaultTest:
  vars:
    manifest: file://manifest.txt

tests:
  # ===== STATE FILTERS (8 tests) =====
  - vars:
      query: "What did Ohio voters say about jobs?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          const hasOhio = ids.every(id => id.includes('race-007'));
          const hasAll = ids.length === 3;
          return hasOhio && hasAll;

  - vars:
      query: "How do Michigan voters feel about the economy?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-001') || id.includes('race-009'));

  - vars:
      query: "Pennsylvania voters on healthcare"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-002') || id.includes('race-010'));

  - vars:
      query: "What did Wisconsin voters think about education?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-003') || id.includes('race-012'));

  - vars:
      query: "Georgia voters on voting rights"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-004'));

  - vars:
      query: "Arizona immigration concerns"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-005'));

  - vars:
      query: "North Carolina suburban voters"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-011'));

  - vars:
      query: "Montana rural voters"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.every(id => id.includes('race-008'));

  # ===== DEMOGRAPHIC FILTERS (4 tests) =====
  - vars:
      query: "What do working-class voters think about trade?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          // Should include Youngstown, Scranton, Flint/Saginaw working-class areas
          return ids.length > 0 && !result.all;

  - vars:
      query: "Latino voters on immigration"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          // Should include Phoenix Latino, Vegas Latino FGs
          return ids.some(id => id.includes('latino') || id.includes('race-005-fg-002') || id.includes('race-006-fg-003'));

  - vars:
      query: "Black voters in Georgia"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('race-004-fg-002') || id.includes('black'));

  - vars:
      query: "College-educated suburban voters"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.length > 0 && !result.all;

  # ===== BROAD QUERIES - SHOULD RETURN ALL (4 tests) =====
  - vars:
      query: "What do voters think about the economy?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  - vars:
      query: "How do people feel about inflation?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  - vars:
      query: "Voter concerns about healthcare costs"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  - vars:
      query: "What messaging resonates with swing voters?"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.all === true;

  # ===== COMPOUND FILTERS (2 tests) =====
  - vars:
      query: "Working-class Ohio voters on manufacturing"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          // Should get Ohio working-class FG specifically
          return ids.some(id => id.includes('race-007'));

  - vars:
      query: "Pennsylvania suburban voters 2024"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('race-010'));

  # ===== EDGE CASES (2 tests) =====
  - vars:
      query: "California voters on housing"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          // Should return empty array with reason (no CA data)
          const ids = result.focus_group_ids || [];
          return ids.length === 0 || result.all === true;

  - vars:
      query: "Cleveland suburbs on local issues"
    assert:
      - type: contains-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const ids = result.focus_group_ids || [];
          return ids.some(id => id.includes('cleveland') || id.includes('race-007-fg-001'));
