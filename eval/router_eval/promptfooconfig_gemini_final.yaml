# Final Router Comparison: Haiku vs Gemini Flash models
# Run: npx promptfoo eval -c promptfooconfig_gemini_final.yaml

description: "Router Final Comparison - Haiku vs Gemini 2.0 vs Gemini 3 Flash"

prompts:
  - file://prompts/router_v2.txt

providers:
  - id: openrouter:anthropic/claude-3-haiku
    label: claude-3-haiku
    config:
      temperature: 0
      max_tokens: 500

  - id: openrouter:google/gemini-2.0-flash-001
    label: gemini-2.0-flash
    config:
      temperature: 0
      max_tokens: 500

  - id: openrouter:google/gemini-3-flash-preview
    label: gemini-3-flash
    config:
      temperature: 0
      max_tokens: 500

defaultTest:
  vars:
    manifest: file://manifest.txt

tests:
  # ===== STATE FILTERS (8 tests) =====
  - vars:
      query: "What did Ohio voters say about jobs?"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-007'));
          } catch { return false; }

  - vars:
      query: "How do Michigan voters feel about the economy?"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-001') || id.includes('race-009'));
          } catch { return false; }

  - vars:
      query: "Pennsylvania voters on healthcare"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-002') || id.includes('race-010'));
          } catch { return false; }

  - vars:
      query: "What did Wisconsin voters think about education?"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-003') || id.includes('race-012'));
          } catch { return false; }

  - vars:
      query: "Georgia voters on voting rights"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-004'));
          } catch { return false; }

  - vars:
      query: "Arizona immigration concerns"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-005'));
          } catch { return false; }

  - vars:
      query: "North Carolina suburban voters"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-011'));
          } catch { return false; }

  - vars:
      query: "Montana rural voters"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length > 0 && ids.every(id => id.includes('race-008'));
          } catch { return false; }

  # ===== BROAD QUERIES (4 tests) =====
  - vars:
      query: "What do voters think about the economy?"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            return result.all === true;
          } catch { return false; }

  - vars:
      query: "How do people feel about inflation?"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            return result.all === true;
          } catch { return false; }

  - vars:
      query: "Voter concerns about healthcare costs"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            return result.all === true;
          } catch { return false; }

  - vars:
      query: "What messaging resonates with swing voters?"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            return result.all === true;
          } catch { return false; }

  # ===== EDGE CASES (2 tests) =====
  - vars:
      query: "California voters on housing"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.length === 0 || result.reason;
          } catch { return false; }

  - vars:
      query: "Cleveland suburbs on local issues"
    assert:
      - type: javascript
        value: |
          let text = output;
          if (text.includes('```')) {
            text = text.split('```')[1];
            if (text.startsWith('json')) text = text.slice(4);
          }
          try {
            const result = JSON.parse(text.trim());
            const ids = result.focus_group_ids || [];
            return ids.some(id => id.includes('cleveland') || id.includes('race-007-fg-001'));
          } catch { return false; }
